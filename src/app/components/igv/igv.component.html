<!-- Loading overlay that will cover only the content area -->
@if (loading) {
<div class="loading-overlay" id="loadingOverlay">
  <!--<div class="loading-message">Loading...</div>-->
  <div class="spinner-blurred">
    <div class="spinner-border" style="width: 5rem; height: 5rem;" role="status"></div>
  </div>
</div>
}
<div class="row g-2">
  <div class="col-12 maps">
    <ul class="navbar-nav" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="explore-tab" data-bs-toggle="pill" type="button" role="tab"
          data-bs-target="#explore" aria-controls="explore" aria-selected="true">Explore
          chromosome</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="interest-tab" data-bs-toggle="pill" type="button" role="tab" data-bs-target="#interest"
          aria-controls="interest" aria-selected="false">Core genes</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="manual-tab" data-bs-toggle="pill" type="button" role="tab"
          data-bs-target="#manual">Search genes</a>
      </li>
    </ul>
  </div>
  <div #igvdiv class="igv" part="igv"></div>
  <!-- Content area -->
  <div class="col-12">
    <div class="tab-content">
      <div class="tab-pane fade show active" id="explore" role="tabpanel" aria-labelledby="explore-tab" tabindex="0">
        <div class="d-flex justify-content-center">
          <button [disabled]="!browser || (genes.length != 0) && (load_progress < 100)" color="accent"
            (click)="getInRangeGenes()" class="btn btn-mcaredb mb-1">
            <i class="fa fa-arrow-up"></i>
            Get DEG data in window
          </button>
        </div>
      </div>
      <div class="tab-pane fade" id="interest" role="tabpanel" aria-labelledby="interest-tab" tabindex="0">
        <div class="row g-2">
          <div class="accordion" id="geneInterestedAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#geneInterested" aria-expanded="true" aria-controls="geneInterested">
                  <div class="row">
                    <div class="col-12">
                      <h4>List of genes interested</h4>
                      <span class="text-muted">Click link to navigate to locus</span>
                    </div>
                  </div>
                </button>
              </h2>
              <div id="geneInterested" class="accordion-collapse collapse"
                data-bs-parent="#geneInterestedAccordion">
                <div class="accordion-body">
                  <div class="row g-2">
                    @for (item of gene_interested; track item; let i = $index) {
                    <a class="col text-decoration-none" (click)="browser.search(item.name)" href="javascript:void(0)">
                      <h5 class="mb-0">{{item.name}}</h5>
                      <small class="text-muted">{{item.stableId ?? ''}}</small>
                    </a>
                    }
                  </div>

                </div>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-center gap-1">
            <button [disabled]="!this.browser || load_progress == 0" class="btn btn-link text-decoration-none"
              (click)="moveGenes(this.grouped_genes, 'left')">
              <i class="fa fa-chevron-left">
              </i>
              {{prevGene}}
            </button>
            <button [disabled]="!this.browser || (genes.length != 0) && (load_progress < 100)" class="btn btn-mcaredb"
              (click)="getDiffExpGenesInterest()">
              <i class="fa fa-magnifying-glass">
              </i>
              Get DEG data of all popular genes
            </button>
            <button [disabled]="!this.browser || load_progress == 0" class="btn btn-link text-decoration-none"
              (click)="moveGenes(this.grouped_genes, 'right')">
              {{nextGene}}
              <i class="fa fa-chevron-right">
              </i>
            </button>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="manual" role="tabpanel" aria-labelledby="manual-tab" tabindex="0">
        <div class="row g-2">
          <textarea class="form-control"
            placeholder="Enter gene symbols or Ensembl IDs separated by commas: Myh6, Gata6, Tbx5, ENSMUSG00000001517, 21944, ..."
            [(ngModel)]="genesEntered"></textarea>
          <div class="d-flex justify-content-center gap-1">
            <button [disabled]="!this.browser || load_progress == 0" class="btn btn-link text-decoration-none"
              (click)="moveGenes(this.grouped_genes, 'left')">
              <i class="fa fa-chevron-left">
              </i>
              {{prevGene}}
            </button>
            <button
              [disabled]="!this.browser || genesEntered.length == 0 || (genes.length != 0) && (load_progress < 100)"
              class="btn btn-mcaredb" (click)="getDiffExpGenesEntered()">
              <i class="fa fa-magnifying-glass">
              </i>
              Get DEG data of entered genes
            </button>
            <button [disabled]="!this.browser || load_progress == 0" class="btn btn-link text-decoration-none"
              (click)="moveGenes(this.grouped_genes, 'right')">
              {{nextGene}}
              <i class="fa fa-chevron-right">
              </i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  @if (this.genes.length > 0) {
  <div class="col-md-3 col-sm-12">
    <div class="sidebar-sticky-top pt-2" [ngStyle]="{ top: 'var(--navbar-height)' }">
      <h4>Cell Types</h4>
      <!--<dx-tag-box style="width: 100%; flex: 1;" [items]="cell_types" [searchEnabled]="true"
          placeholder="Select Cell Type(s)" (onValueChanged)="onCellChanged($event)" [showClearButton]="true"
          [showSelectionControls]="true" [multiline]="false" [maxDisplayedTags]="5" [value]='cell_types'
        paginate='true'></dx-tag-box>-->
      <ng-select [items]="cell_types" [searchable]="true" [clearable]="true" (onValueChanged)="onCellChanged($event)"
        placeholder="Select Cell Type(s)" [(ngModel)]="selected_cells" [selectableGroup]="true"
        [selectableGroupAsModel]="false" [closeOnSelect]="false" [addTag]="false" [multiple]="true">
        <ng-template ng-option-tmp let-item="item" let-item$="item$" let-index="index">
          <div class="d-flex justify-content-left align-items-center" style="gap: .5rem">
            <input id="item-{{ index }}" type="checkbox" class="form-check-input me-0 mt-0"
              [ngModel]="item$.selected" />
            <label class="flex-grow-1 text-truncate" style="min-width: 0px !important;" for="item-{{index}}">
              {{ item }}
            </label>
          </div>
        </ng-template>
      </ng-select>
      <hr />
      <div class="progress mb-2" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0"
        aria-valuemax="100">
        <div class="progress-bar text-bg-mcaredb" [class.progress-bar-striped]="load_progress != 100"
          [class.progress-bar-animated]="load_progress != 100" [style.width]="load_progress + '%'">
          {{`${load_progress.toFixed(2)}%`}}</div>
      </div>
      <button class="btn btn-mcaredb w-100" id="btn-apply-detail" [disabled]="!completely_loaded"
        (click)="subsetCorrectCellAndTissueTypes()">
        <i class="fa fa-arrows-rotate"></i> Apply
      </button>
      <hr />
      <h4>Legends</h4>
      <div class="color-legend">
        <h6 class="col" style="color:rgb(255, 99, 99);">Significantly Downregulated</h6>
        <h6 class="col" style="color: rgb(170, 170, 0);">Slightly Downregulated</h6>
        <h6 class="col" style="color: rgb(50, 255, 50);">No Change</h6>
        <h6 class="col" style="color: rgb(255, 99, 255);">Slightly Upregulated</h6>
        <h6 class="col" style="color: rgb(99, 99, 255);">Significantly Upregulated</h6>
        <h6 class="col" style="color: black;">Not have a significant fit</h6>
      </div>
      <hr />
      <h4>Notes</h4>
      <ol>
        <li class="text-muted">All clusters with -Log<sub>10</sub>P-val less than 0.01 were hidden in the model plot.
        </li>
        <li class="text-muted">Numbers on the meta plot were hidden if the sample size is less than 2.</li>
      </ol>
    </div>
  </div>
  }

  @if (this.genes.length > 0) {
  <div class="col-md-9 col-sm-12 mt-2" [class.searching]="loading">
    <div class="accordion" id="accordionExample">
      @for (gene_list of this.grouped_genes; track gene_list) {
      @if (gene_list[0]) {
      <div class="accordion-item" app-gene-card [gene_list]="gene_list" [indices]="selected_indices"
        [completely_loaded]="completely_loaded">
      </div>
      }
      }
    </div>
  </div>
  }
</div>