<!--@if (loading) {
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner-blurred">
    <div class="spinner-border" style="width: 5rem; height: 5rem;" role="status"></div>
  </div>
</div>
}-->
<div class="row d-flex g-2">
  <h2 translate="navbar.pathway"></h2>
  <div class="col-lg-3 col-md-12">
    <div class="sidebar-sticky-top pt-2" [ngStyle]="{ top: 'var(--navbar-height)' }">
      <h4 translate="pathway.filterarea.comparison"></h4>
      <select class="form-select" aria-label="Default select example" [(ngModel)]="selectedComparisonType"
        (change)="prepareData()">
        @for (item of comparisonTypes; track item) {
        <option [value]="item.value">{{item.text}}</option>
        }
      </select>

      <hr />
      <!--CELL TYPE SELECT BOX-->
      <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
        <h4 translate="pathway.filterarea.celltype" class="mb-0"></h4>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-link text-decoration-none" (click)="selected_cell_types = []; onCellsChanged()">
            <i class="fa fa-times"></i> {{'pathway.filterarea.deselectAll' | translate}}
          </button>
          <button class="btn btn-sm btn-link text-decoration-none"
            (click)="selected_cell_types = cell_types.slice(); prepareData()">
            <i class="fa fa-refresh"></i> {{'pathway.filterarea.reset' | translate}}
          </button>
        </div>
      </div>
      <ng-select [items]="cell_types" [searchable]="true" [clearable]="true" placeholder="Select Cell Type(s)"
        [(ngModel)]="selected_cell_types" [selectableGroup]="true" [selectableGroupAsModel]="false"
        [closeOnSelect]="false" [addTag]="false" [multiple]="true" (change)="onCellsChanged()">
        <ng-template ng-option-tmp let-item="item" let-item$="item$" let-index="index">
          <div class="d-flex justify-content-left align-items-center" style="gap: .5rem">
            <input id="item-{{ index }}" type="checkbox" class="form-check-input me-0 mt-0"
              [ngModel]="item$.selected" />
            <label class="flex-grow-1 text-truncate" style="min-width: 0px !important;" for="item-{{index}}">
              {{ item }}
            </label>
          </div>
        </ng-template>
      </ng-select>
      <hr />
      <!-- FDR Filter -->
      <h4>{{'pathway.filterarea.fdrqval' | translate}}</h4>
      <div class="d-flex align-items-center justify-content-between gap-2">
        <input tabindex="0" type="range" class="form-range" min="0.01" max="1" step="0.01" [(ngModel)]="fdr_cutoff"
          (change)="CutoffChanged()" />
        <span style="width: 4rem;text-align: right;">{{fdr_cutoff}}</span>
      </div>
      <hr />

      <!-- NES Filter -->
      <h4>{{'pathway.filterarea.nes' | translate}}</h4>
      <div class="d-flex align-items-center justify-content-between gap-2">
        <div class="flex-grow-1 slider-track">
          <!-- Track background
          <div class="slider-track"></div>

          Active range highlight
          <div class="slider-range"
            [style.left]="(nes_min_bound - nes_slider_min) / (nes_slider_max - nes_slider_min) * 100 + '%'"
            [style.right]="(nes_slider_max - nes_max_bound) / (nes_slider_max - nes_slider_min) * 100 + '%'">
          </div> -->

          <!-- Min thumb -->
          <input type="range" class="form-range slider-thumb" [min]="nes_slider_min" [max]="nes_slider_max" step="0.1"
            [(ngModel)]="nes_min_bound" (change)="nesMinChanged()" (change)="CutoffChanged()">

          <!-- Max thumb -->
          <input type="range" class="form-range slider-thumb" [min]="nes_slider_min" [max]="nes_slider_max" step="0.1"
            [(ngModel)]="nes_max_bound" (change)="nesMaxChanged()" (change)="CutoffChanged()">
        </div>
        <span style="width: 4rem; text-align: right;" class="text-nowrap">
          {{nes_min_bound}} ~ {{nes_max_bound}}
        </span>
      </div>
      <hr />


      <div class="d-flex mb-2 justify-content-between align-items-center">
        <h4 class="mb-0" translate="pathway.filterarea.pathway"></h4>
        @if (pathway_info != '' && pathway_info != null) {
        <div class="btn-group">
          <a class="btn btn-sm btn-link text-decoration-none" title="Pathway browser" tabindex="0" target="_blank"
            [href]="pathway_groupby_go ? `https://biocyc.org/HUMAN/NEW-IMAGE?type=ECOCYC-CLASS&object=${go_terms[0].goid}#cy_${go_terms[0].goid}` : `https://www.kegg.jp/pathway/${go_terms[0].goid}`">
            <i class="fa fa-map"></i> {{'pathway.filterarea.diagram' | translate}}
          </a>
          <a tabindex="0" id="go_pathway_btn" data-bs-trigger="focus" title="Pathway information"
            class="btn btn-sm btn-link text-decoration-none" role="button"
            [popoverTitle]="pathway_groupby_go ? pathway_info?.name : go_terms[0].pathway"
            placement="right"
            [ngbPopover]="pathway_groupby_go ? pathway_info?.definition.text : pathway_info"><i
              class="fa fa-info-circle"></i> {{'pathway.filterarea.info' | translate}}
          </a>
        </div>
        }
      </div>
      <div class="d-flex">
        <!--<dx-autocomplete [dataSource]="pathways" [(value)]="selected_pathway" [minSearchLength]="1" searchEnabled="true"
          [searchMode]="selected_search_mode" [maxItemCount]="200" [showDropDownButton]="true"></dx-autocomplete>-->
        @if (pathway_groupby_go) {
        <ng-select [items]="pathways" [searchable]="true" [clearable]="true" [(ngModel)]="selected_pathway"
          [closeOnSelect]="true" [addTag]="false" [multiple]="false" class="flex-grow-1"
          style="min-width: 0px !important;" placeholder="Select pathway" (change)="onPathwayChange()"
          [virtualScroll]="true">
        </ng-select>
        }
        @if (!pathway_groupby_go) {
        <ng-select [items]="kegg_pathways" [searchable]="true" [clearable]="true" [(ngModel)]="selected_pathway_kegg"
          [closeOnSelect]="true" [addTag]="false" [multiple]="false" class="flex-grow-1"
          style="min-width: 0px !important;" placeholder="Select pathway" (change)="onPathwayChange()"
          [virtualScroll]="true">
        </ng-select>
        }
      </div>

      <!--<div class="d-flex">
        @if (pathway_info != '' && pathway_info != null) {
        <a tabindex="0" id="kegg_pathway_btn" data-bs-trigger="focus" class="btn btn-link btn-floating text-body"
          role="button" data-bs-toggle="popover" data-bs-title="KEGG Pathway Information"
          data-bs-content="This function is currently unavailable due to technical issues."><i class="fa fa-info-circle"></i></a>
        }
      </div>-->
      <h5 class="mt-2" translate="pathway.filterarea.groupby"></h5>
      <input tabindex="0" type="radio" class="btn-check" name="options-base" id="option5" [value]="true"
        autocomplete="off" [(ngModel)]="pathway_groupby_go" (change)="onPathwayChange()">
      <label tabindex="0" class="btn btn-outline-mcaredb w-100 text-start" for="option5">
        <div class="d-flex flex-column w-100 justify-content-left">
          <h5 translate="pathway.filterarea.go"></h5>
          <small translate="pathway.filterarea.go-d"></small>
        </div>
      </label>

      <input tabindex="0" type="radio" class="btn-check" name="options-base" id="option6" [value]="false"
        autocomplete="off" [(ngModel)]="pathway_groupby_go" (change)="onPathwayChange()">
      <label tabindex="0" class="btn btn-outline-mcaredb w-100 text-start mt-2" for="option6">
        <div class="d-flex flex-column w-100 justify-content-left">
          <h5 translate="pathway.filterarea.kegg"></h5>
          <small translate="pathway.filterarea.kegg-d"></small>
        </div>
      </label>
    </div>
  </div>
  <div class="col-lg-6 col-md-12">
    @if (loading) {
    <div class="w-100 h-100 d-flex">
      <div class="d-flex align-items-center justify-content-center w-100">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden" translate="expression.loading"></span>
          </div>
        </div>
      </div>
    </div>
    }
    @if (!loading) {
    <div class="d-flex flex-column h-100 align-items-between">
      <div class="flex-grow-1">
        <apx-chart #chart [series]="go_chart_options.series!" [chart]="go_chart_options.chart!"
          [xaxis]="go_chart_options.xaxis!" [yaxis]="go_chart_options.yaxis!" [markers]="go_chart_options.markers!"
          [annotations]="go_chart_options.annotations!" [tooltip]="go_chart_options.tooltip!"
          [theme]="go_chart_options.theme!">
        </apx-chart>
      </div>
      <div class="flex-shrink-0">
        @if (!term_selected&&!loading) {
        <div class="mt-3">
          <p class="text-center text-muted" translate="pathway.body.select"></p>
        </div>
        }
        @if (term_selected) {
        <div class="row g-2">
          <div class="col-12">
            <div class="card">
              <div class="card-header text-center">
                <h4 class="mb-0" translate="pathway.body.selected"></h4>
              </div>
              <div class="card-body position-relative">
                <div class="row">
                  <div class="col-6">
                    <small class="text-muted" translate="pathway.body.cluster"></small>
                    <h5>{{selected_term.cell_type}}</h5>
                    <hr />
                    <div class="row">
                      <div class="col-6">
                        <small class="text-muted" translate="pathway.body.nes"></small>
                        <h5>{{selected_term.nes}}</h5>
                      </div>
                      <div class="col-6">
                        <small class="text-muted" translate="pathway.body.pval"></small>
                        <h5 [class]="selected_term.P_Value <= 0.05 ? 'text-success' : 'text-danger'">
                          {{(selected_term.P_Value > 0.0001 ? selected_term.P_Value.toFixed(4) : "&lt;0.0001")}}</h5>
                      </div>
                    </div>
                    <hr />
                    <small class="text-muted">PMID</small>
                    <h5><a tabindex="0"
                        [href]="'https://pubmed.ncbi.nlm.nih.gov/' + selected_term.pmid.toString().replace('34489413', '32220304')" target="_blank">{{selected_term.pmid.toString().replace("34489413", "32220304")}}</a></h5>
                  </div>
                  <div class="position-absolute top-0 end-0 bottom-0
                  overflow-auto  list-group list-group-flush" style="width: 50%;">
                    <h6 class="text-center"><br />{{'pathway.body.enriched' | translate}}</h6>
                    @for (item of selected_core_enrichment; track item) {
                    <button tabindex="0" type="button" class="list-group-item list-group-item-action"
                      (click)="geneRerout(item)">
                      {{item}}
                    </button>
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        }
      </div>
    </div>
    }
  </div>

  <div class="col-lg-3 col-md-12">
    <div class="d-flex flex-column h-100 gap-2">
      <div class="card flex-fill" style="min-height: 0;">
        <div class="card-header">
          <h4 class="mb-0"><i class="fa fa-arrow-up"></i> {{'pathway.body.up' | translate}}</h4>
        </div>
        <ul class="list-group list-group-flush overflow-y-auto d-flex flex-fill" style="height: 35vh;">
          @if (loading) {
          @for (n of [].constructor(20); track n) {
          <li class="list-group-item list-group-item-action placeholder-glow d-flex justify-content-between">
            <span [class]="'placeholder col-' + getRandom(5, 8)"></span>
            <span [class]="'placeholder col-' + getRandom(1, 3)"></span>
          </li>
          }
          }
          @if (!loading) {
          @for (item of upreg_gene_counts; track item) {
          <button class="list-group-item list-group-item-action gene-regulated d-flex justify-content-between"
            type="button" (click)="geneRerout(item.gene)" [ngStyle]="getColorStyle(item, 'DOWN')">
            <span>{{ item.gene }}</span>
            <span>{{ item.count }}</span>
          </button>
          }
          }
        </ul>
      </div>
      <div class="card flex-fill" style="min-height: 0;">
        <div class="card-header">
          <h4 class="mb-0"><i class="fa fa-arrow-down"></i> {{'pathway.body.down' | translate}}</h4>
        </div>
        <ul class="list-group list-group-flush overflow-y-auto d-flex flex-fill" style="height: 35vh;">
          @if (loading) {
          @for (n of [].constructor(20); track n) {
          <li class="list-group-item list-group-item-action placeholder-glow d-flex justify-content-between">
            <span [class]="'placeholder col-' + getRandom(5, 8)"></span>
            <span [class]="'placeholder col-' + getRandom(1, 3)"></span>
          </li>
          }
          }
          @if (!loading) {
          @for (item of downreg_gene_counts; track item) {
          <button class="list-group-item gene-regulated d-flex justify-content-between list-group-item-action"
            type="button" (click)="geneRerout(item.gene)" [ngStyle]="getColorStyle(item, 'DOWN')">
            <span>{{ item.gene }}</span>
            <span>{{ item.count }}</span>
          </button>
          }
          }
        </ul>
      </div>
    </div>
  </div>
</div>